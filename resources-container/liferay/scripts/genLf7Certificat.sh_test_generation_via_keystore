## Delete old keystore
rm -f /opt/liferay/ssl/keystore.jks
rm -f /opt/liferay/ssl/cacerts.jks
rm -f /opt/liferay/ssl/server.cer

## Generate jks
#$JAVA_HOME/bin/keytool -genkey -keyalg RSA -alias selfsigned -keystore /opt/liferay/ssl/keystore.jks -storepass password -validity 360 -keysize 2048 -dname ${DNAME:-CN=liferay-domain-back,OU=liferay-domain-back,C=liferay-domain-back} -storetype PKCS12
$JAVA_HOME/bin/keytool -genkey -keyalg RSA -alias server-alias -keystore /opt/liferay/ssl/keystore.jks -storepass password -validity 360 -keysize 2048 -dname ${DNAME:-CN=lbi_liferay,OU=lbi_liferay,C=lbi_liferay} -storetype PKCS12

$JAVA_HOME/bin/keytool -list -v -keystore /opt/liferay/ssl/keystore.jks -storepass password

$JAVA_HOME/bin/keytool -export -alias server-alias -storepass password -file /opt/liferay/ssl/server.cer -keystore /opt/liferay/ssl/keystore.jks

$JAVA_HOME/bin/keytool -import -noprompt -v -alias server-alias -file /opt/liferay/ssl/server.cer -keystore /opt/liferay/ssl/cacerts.jks -keypass password -storepass password


echo "******************************** List /opt/liferay/ssl/cacerts.jks ********************************"

$JAVA_HOME/bin/keytool -list -v -keystore /opt/liferay/ssl/cacerts.jks -storepass password

cp /opt/liferay/tomcat/conf/server.xml /opt/liferay/tomcat/conf/server.xml_bk

sed -i '86d;94d' /opt/liferay/tomcat/conf/server.xml

#sed -i '
#    s/@/@A/g; s/{/@B/g; s/}/@C/g; s/<!--/{/g; s/-->/}/g;
#    s/{\([^}]*Http11NioProtocol[^}]*\)}/\1/g;
#    s/}/-->/g; s/{/<!--/g; s/@C/}/g; s/{/@B/g; s/@A/@/g
#' /opt/liferay/tomcat/conf/server.xml

STR1='certificateKeystoreFile\=\"conf\/localhost-rsa.jks\"'
STR2='certificateKeystoreFile=\"\/opt\/liferay\/ssl\/cacerts.jks\" certificateKeystorePassword=\"password\" certificateKeyAlias=\"server-alias\" certificateKeystoreType=\"PKCS12\"'
sed -i 's/'"$STR1"'/'"$STR2"'/g' /opt/liferay/tomcat/conf/server.xml


#STR3='type=\"RSA\"'
#sed -i 's/'"$STR3"'/'" "'/g' /opt/liferay/tomcat/conf/server.xml

cat /opt/liferay/tomcat/conf/server.xml



